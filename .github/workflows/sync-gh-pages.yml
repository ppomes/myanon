name: Sync README to gh-pages

on:
  push:
    branches: [main]
    paths: [README.md]

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update gh-pages index.md
        run: |
          git checkout gh-pages
          # Preserve front matter, replace body with README content
          cat > index.md <<'FRONTMATTER'
          ---
          title: "A mysqldump anonymizer"
          title-heading: false
          ---

          FRONTMATTER
          # Remove leading spaces from heredoc
          sed -i 's/^          //' index.md
          # Append README, skipping the first H1 line (redundant with site title)
          tail -n +2 <(git show main:README.md) >> index.md
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add index.md
          git diff --cached --quiet || git commit -m "Sync index.md from README.md"
          git push origin gh-pages
